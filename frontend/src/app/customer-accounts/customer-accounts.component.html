<div class="container mt-4">
  <!-- Customer Details Card -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Customer Details</h5>
    </div>
    <div class="card-body">
      <p><strong>Customer ID:</strong> {{ customerId }}</p>
      <div *ngIf="customer">
        <p><strong>Name:</strong> {{ customer.name }}</p>
        <p><strong>Email:</strong> {{ customer.email }}</p>
      </div>
      <div *ngIf="!customer">
        <em>Loading customer data or data not available...</em>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

  <!-- Add Account Buttons -->
  <div class="mb-3 d-flex gap-2">
    <button class="btn btn-success" (click)="toggleCreateCurrentAccountForm()">
      <i class="bi bi-plus-circle-fill"></i> Add Current Account
    </button>
    <button class="btn btn-info" (click)="toggleCreateSavingAccountForm()">
      <i class="bi bi-plus-circle-fill"></i> Add Saving Account
    </button>
  </div>

  <!-- Create Current Account Form -->
  <div *ngIf="showCreateCurrentAccountForm" class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">New Current Account</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="currentAccountForm" (ngSubmit)="handleCreateCurrentAccount()">
        <div class="mb-3">
          <label for="currentInitialBalance" class="form-label">Initial Balance</label>
          <input type="number" id="currentInitialBalance" formControlName="initialBalance" class="form-control">
          <!-- Add validation messages if needed -->
        </div>
        <div class="mb-3">
          <label for="overDraft" class="form-label">Overdraft</label>
          <input type="number" id="overDraft" formControlName="overDraft" class="form-control">
          <!-- Add validation messages if needed -->
        </div>
        <button type="submit" class="btn btn-primary me-2" [disabled]="currentAccountForm.invalid">Create</button>
        <button type="button" class="btn btn-secondary" (click)="toggleCreateCurrentAccountForm()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Create Saving Account Form -->
  <div *ngIf="showCreateSavingAccountForm" class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">New Saving Account</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="savingAccountForm" (ngSubmit)="handleCreateSavingAccount()">
        <div class="mb-3">
          <label for="savingInitialBalance" class="form-label">Initial Balance</label>
          <input type="number" id="savingInitialBalance" formControlName="initialBalance" class="form-control">
        </div>
        <div class="mb-3">
          <label for="interestRate" class="form-label">Interest Rate (%)</label>
          <input type="number" id="interestRate" formControlName="interestRate" class="form-control">
        </div>
        <button type="submit" class="btn btn-primary me-2" [disabled]="savingAccountForm.invalid">Create</button>
        <button type="button" class="btn btn-secondary" (click)="toggleCreateSavingAccountForm()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Accounts List -->
  <div class="card mt-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">Bank Accounts</h5>
    </div>
    <div class="card-body">
      <div *ngIf="accounts$ | async as accounts; else loadingAccounts">
        <div *ngIf="accounts.length > 0; else noAccounts">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Account ID</th>
                <th>Type</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let acc of accounts">
                <td>{{ acc.id }}</td>
                <td>{{ acc.type === 'CurrentBankAccountDTO' ? 'Current' : (acc.type === 'SavingBankAccountDTO' ? 'Saving' : acc.type) }}</td>
                <td>{{ acc.balance | currency:'EUR':'symbol' }}</td>
                <td>{{ acc.status }}</td>
                <td>{{ acc.createdAt | date:'medium' }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary me-1 mb-1" title="View Details/Operations" (click)="viewAccountOperations(acc)">
                    <i class="bi bi-eye-fill"></i> <span class="d-none d-md-inline">Details</span>
                  </button>
                  <button *ngIf="authService.roles.includes('ADMIN')" class="btn btn-sm btn-outline-success me-1 mb-1" title="Credit" (click)="openCreditModal(acc)">
                    <i class="bi bi-arrow-down-circle-fill"></i> <span class="d-none d-md-inline">Credit</span>
                  </button>
                  <button *ngIf="authService.roles.includes('ADMIN')" class="btn btn-sm btn-outline-danger me-1 mb-1" title="Debit" (click)="openDebitModal(acc)">
                    <i class="bi bi-arrow-up-circle-fill"></i> <span class="d-none d-md-inline">Debit</span>
                  </button>
                  <button *ngIf="authService.roles.includes('ADMIN')" class="btn btn-sm btn-outline-warning mb-1" title="Transfer" (click)="openTransferModal(acc)">
                    <i class="bi bi-send-fill"></i> <span class="d-none d-md-inline">Transfer</span>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noAccounts>
          <p class="text-muted">No bank accounts found for this customer.</p>
        </ng-template>
      </div>
      <ng-template #loadingAccounts>
        <p class="text-muted fst-italic">Loading accounts...</p>
        <div *ngIf="errorMessage && !(accounts$ | async)" class="alert alert-warning">
           {{ errorMessage }}
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Modals for Operations -->

<!-- Credit Modal -->
<div class="modal fade" id="creditModal" tabindex="-1" aria-labelledby="creditModalLabel" aria-hidden="true" [ngClass]="{'show d-block': showCreditModal}" (click)="closeCreditModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="creditModalLabel">Credit Account: {{ selectedAccountForOperation?.id }}</h5>
        <button type="button" class="btn-close" (click)="closeCreditModal()" aria-label="Close"></button>
      </div>
      <form [formGroup]="operationAmountForm" (ngSubmit)="handleCredit()">
        <div class="modal-body">
          <div class="mb-3">
            <label for="creditAmount" class="form-label">Amount</label>
            <input type="number" id="creditAmount" formControlName="amount" class="form-control">
            <!-- Add validation errors -->
          </div>
          <div class="mb-3">
            <label for="creditDescription" class="form-label">Description</label>
            <input type="text" id="creditDescription" formControlName="description" class="form-control">
            <!-- Add validation errors -->
          </div>
          <div *ngIf="errorMessage" class="alert alert-danger mt-2">{{ errorMessage }}</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCreditModal()">Close</button>
          <button type="submit" class="btn btn-success" [disabled]="operationAmountForm.invalid">Perform Credit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Debit Modal -->
<div class="modal fade" id="debitModal" tabindex="-1" aria-labelledby="debitModalLabel" aria-hidden="true" [ngClass]="{'show d-block': showDebitModal}" (click)="closeDebitModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="debitModalLabel">Debit Account: {{ selectedAccountForOperation?.id }}</h5>
        <button type="button" class="btn-close" (click)="closeDebitModal()" aria-label="Close"></button>
      </div>
      <form [formGroup]="operationAmountForm" (ngSubmit)="handleDebit()">
        <div class="modal-body">
          <div class="mb-3">
            <label for="debitAmount" class="form-label">Amount</label>
            <input type="number" id="debitAmount" formControlName="amount" class="form-control">
          </div>
          <div class="mb-3">
            <label for="debitDescription" class="form-label">Description</label>
            <input type="text" id="debitDescription" formControlName="description" class="form-control">
          </div>
          <div *ngIf="errorMessage" class="alert alert-danger mt-2">{{ errorMessage }}</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDebitModal()">Close</button>
          <button type="submit" class="btn btn-danger" [disabled]="operationAmountForm.invalid">Perform Debit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true" [ngClass]="{'show d-block': showTransferModal}" (click)="closeTransferModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transferModalLabel">Transfer from Account: {{ selectedAccountForOperation?.id }}</h5>
        <button type="button" class="btn-close" (click)="closeTransferModal()" aria-label="Close"></button>
      </div>
      <form [formGroup]="transferForm" (ngSubmit)="handleTransfer()">
        <div class="modal-body">
          <div class="mb-3">
            <label for="transferAmount" class="form-label">Amount</label>
            <input type="number" id="transferAmount" formControlName="amount" class="form-control">
          </div>
          <div class="mb-3">
            <label for="accountDestination" class="form-label">Destination Account ID</label>
            <input type="text" id="accountDestination" formControlName="accountDestination" class="form-control">
          </div>
          <div class="mb-3">
            <label for="transferDescription" class="form-label">Description</label>
            <input type="text" id="transferDescription" formControlName="description" class="form-control">
          </div>
           <div *ngIf="errorMessage" class="alert alert-danger mt-2">{{ errorMessage }}</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeTransferModal()">Close</button>
          <button type="submit" class="btn btn-warning" [disabled]="transferForm.invalid">Perform Transfer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Backdrop for Modals -->
<div class="modal-backdrop fade" [ngClass]="{'show': showCreditModal || showDebitModal || showTransferModal}" style="display: none;" [style.display]="(showCreditModal || showDebitModal || showTransferModal) ? 'block' : 'none'"></div>